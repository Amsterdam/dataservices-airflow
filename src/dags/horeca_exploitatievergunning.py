import pandas as pd
from airflow import DAG
from airflow.operators.postgres_operator import PostgresOperator
from airflow.operators.python_operator import PythonOperator
from geoalchemy2 import Geometry, WKTElement
from shapely import wkt
from shapely.geometry.multipolygon import MultiPolygon
from shapely.geometry.polygon import Polygon
from shapely.geometry.point import Point
from sqlalchemy.types import Date, Integer, Text

from common import default_args
from common.sql import SQL_CHECK_COUNT, SQL_CHECK_GEO
from common.db import get_engine, get_ora_engine
from postgres_check_operator import PostgresCheckOperator
from postgres_permissions_operator import PostgresPermissionsOperator

dag_id = "horeca_exploitatievergunning"

table_name = dag_id
table_name_new = f"{table_name}_new"
SQL_TABLE_RENAME = f"""
    DROP TABLE IF EXISTS {table_name} CASCADE;
    ALTER TABLE {table_name_new} RENAME TO {table_name};
    ALTER TABLE {table_name} RENAME CONSTRAINT {table_name_new}_pkey TO {table_name}_pkey;
    ALTER INDEX ix_{table_name_new}_id RENAME TO ix_{table_name}_id;
    ALTER INDEX idx_{table_name_new}_locatie RENAME TO idx_{table_name}_locatie;
    ALTER INDEX idx_{table_name_new}_terrasgeometrie RENAME TO idx_{table_name}_terrasgeometrie;
"""


def wkt_loads_wrapped(data):
    if not isinstance(data, str):
        return data
    p = wkt.loads(data)
    if isinstance(p, Polygon):
        p = MultiPolygon([p])
    elif isinstance(p, MultiPolygon) or isinstance(p, Point):
        pass
    else:
        p = None
    if p:
        p = WKTElement(p.wkt, srid=4326)
    return p


def load_from_dwh(table_name):
    db_engine = get_engine()
    dwh_ora_engine = get_ora_engine("oracle_dwh_stadsdelen")
    with dwh_ora_engine.connect() as connection:
        df = pd.read_sql(
            """
select ZAAKNUMMER
    , ZAAKNAAM
    , ADRES
    , ZAAK_CATEGORIE
    , ZAAK_SPECIFICATIE
    , BEGINDATUM
    , EINDDATUM
    , OPENINGSTIJDEN_ZO_DO_VAN
    , OPENINGSTIJDEN_ZO_DO_TOT
    , OPENINGSTIJDEN_VR_ZA_VAN
    , OPENINGSTIJDEN_VR_ZA_TOT
    , O_TIJDEN_TERRAS_ZO_DO_VAN
    , O_TIJDEN_TERRAS_ZO_DO_TOT
    , O_TIJDEN_TERRAS_VR_ZA_VAN
    , O_TIJDEN_TERRAS_VR_ZA_TOT
    , LOCATIE_WKT AS LOCATIE
    , TERRASGEOMETRIE_WKT AS TERRASGEOMETRIE
    , POSTCODE
    , STATUS_VERGUNNING
    , STATUS_TIJDELIJK_TERRAS
    , TOESTEMMING_TIJDELIJK_TERRAS
    , PUBL_BESLUIT_TIJDELIJK_TERRAS
    , TIJDELIJK_TERRAS_DETAILS
    , STATUS_VERLENG_TIJDELK_TERRAS
    , VERLENG_TIJDELK_TERRAS_DETAIL
from DMDATA.HORECA_EXPLOITATIEVERGUNNING_V 
        """,
            connection,
            coerce_float=True,
            params=None,
            parse_dates=["begindatum", "einddatum"],
            columns=None,
            chunksize=None,
        )
        df["locatie"] = df["locatie"].apply(wkt_loads_wrapped)
        df["terrasgeometrie"] = df["terrasgeometrie"].apply(wkt_loads_wrapped)
        dtype = {
            "zaaknummer": Integer(),
            "zaaknaam": Text(),
            "zaakcategorie": Text(),
            "zaakspecificatie": Text(),
            "begindatum": Date(),
            "einddatum": Date(),
            "openingstijden_zo_do_van": Text(),
            "openingstijden_zo_do_tot": Text(),
            "openingstijden_vr_za_van": Text(),
            "openingstijden_vr_za_tot": Text(),
            "o_tijden_terras_zo_do_van": Text(),
            "o_tijden_terras_zo_do_tot": Text(),
            "o_tijden_terras_vr_za_van": Text(),
            "o_tijden_terras_vr_za_tot": Text(),
            "locatie": Geometry(geometry_type="POINT", srid=4326),
            "terrasgeometrie": Geometry(geometry_type="MULTIPOLYGON", srid=4326),
            "postcode": Text(),
            "status_vergunning": Text(),
            "status_tijdelijk_terras": Text(),
            "toestemming_tijdelijk_terras": Text(),
            "publ_besluit_tijdelijk_terras": Text(),
            "tijdelijk_terras_details": Text(),
            "status_verleng_tijdelk_terras": Text(),
            "verleng_tijdelk_terras_detail": Text(),
        }
        df.to_sql(
            table_name, db_engine, if_exists="replace", index_label="id", dtype=dtype
        )
        with db_engine.connect() as connection:
            connection.execute(f"ALTER TABLE {table_name} ADD PRIMARY KEY (id)")
            connection.execute(
                f"""
                 ALTER TABLE {table_name}
                 ALTER COLUMN terrasgeometrie TYPE geometry(MultiPolygon,28992)
                 USING ST_Transform(terrasgeometrie,28992)
             """
            )
            connection.execute(
                f"""
                 ALTER TABLE {table_name}
                 ALTER COLUMN locatie TYPE geometry(Point,28992)
                 USING ST_Transform(locatie,28992)
             """
            )
            # connection.execute(f"DELETE FROM {table_name} WHERE terrasgeometrie is NULL")
            connection.execute(
                f"""
                 UPDATE {table_name}
                 SET terrasgeometrie = ST_CollectionExtract(ST_Makevalid(terrasgeometrie), 3)
                 WHERE ST_IsValid(terrasgeometrie) = False;
             """
            )
            connection.execute(
                f"""
                 ALTER TABLE {table_name}
                 RENAME COLUMN VERLENG_TIJDELK_TERRAS_DETAIL to VERLENGING_TIJDELIJK_TERRAS_DETAILS;
                 ALTER TABLE {table_name}
                 RENAME COLUMN STATUS_VERLENG_TIJDELK_TERRAS to STATUS_VERLENGING_TIJDELIJK_TERRAS;                  
             """
            )      


with DAG(
    "horeca_exploitatievergunning",
    default_args=default_args,
    description="Horeca Exploitatievergunning",
    schedule_interval="0 9 * * *",
) as dag:

    load_data = PythonOperator(
        task_id="load_data", python_callable=load_from_dwh, op_args=[table_name_new],
    )

    check_count = PostgresCheckOperator(
        task_id="check_count",
        sql=SQL_CHECK_COUNT,
        params=dict(tablename=table_name_new, mincount=4000),
    )

    check_geo1 = PostgresCheckOperator(
        task_id="check_geo1",
        sql=SQL_CHECK_GEO,
        params=dict(
            tablename=table_name_new,
            geotype="ST_MultiPolygon",
            geo_column="terrasgeometrie",
            notnull=False,
        ),
    )

    check_geo2 = PostgresCheckOperator(
        task_id="check_geo2",
        sql=SQL_CHECK_GEO,
        params=dict(
            tablename=table_name_new,
            geotype="ST_Point",
            geo_column="locatie",
            notnull=False,
        ),
    )

    rename_table = PostgresOperator(task_id="rename_table", sql=SQL_TABLE_RENAME)

    # Grant database permissions
    grant_db_permissions = PostgresPermissionsOperator(
        task_id="grants",
        dag_name=dag_id
    )

load_data >> check_count >> check_geo1 >> check_geo2 >> rename_table >> grant_db_permissions
